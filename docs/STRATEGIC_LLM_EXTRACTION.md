# TDS Guardian - Strategic Agent LLM System Extraction

This document contains extracted information about the Strategic Agent LLM system from the TDS Guardian codebase.

---

## 1. STRATEGIC AGENT SYSTEM PROMPT

**File:** `src/llm/strategic_llm.rs:140-176`

**Note:** The Strategic LLM uses an inline prompt within the `diagnose()` function. There is no separate system prompt constant.

```rust
let prompt = format!(
    r#"You are an expert drilling equipment diagnostician for TDS-11SA top drive systems.

ANOMALY TICKET:
- Sensor: {}
- Type: {}
- Severity: {:?}
- Kurtosis: {:.2}
- Operational State: {:?}
- Timestamp: {}

PHYSICS ANALYSIS:
- Cumulative Fatigue Damage (Miner's Rule): {:.4} (1.0 = theoretical failure)
- Remaining L10 Bearing Life: {:.1} hours
- Wear Acceleration Factor: {:.2}x normal

EQUIPMENT KNOWLEDGE:
{}

Based on this data, provide:
1. DIAGNOSIS: Root cause analysis in exactly 2 sentences.
2. ACTION: Recommended action in exactly 1 sentence.

Format your response exactly as:
DIAGNOSIS: [your 2-sentence diagnosis]
ACTION: [your 1-sentence recommendation]"#,
    ticket.sensor_name,
    ticket.anomaly_type,
    ticket.severity,
    ticket.kurtosis,
    ticket.state,
    ticket.timestamp,
    physics.cumulative_damage,
    physics.l10_life_hours,
    physics.wear_acceleration,
    context_str
);
```

The mistral.rs backend also uses a generic system prompt in `src/llm/mistral_rs.rs:244-246`:
```rust
let system_prompt = "You are a vibration analysis expert for industrial drilling equipment. Reply concisely.";
```

---

## 2. STRATEGIC PROMPT CONSTRUCTION CODE

There are **multiple prompt construction functions** for different use cases:

### 2.1 Anomaly Diagnosis Prompt (Primary)

**File:** `src/llm/strategic_llm.rs:118-176`

**Function:** `StrategicLLM::diagnose()`

Used when a verified anomaly ticket needs diagnosis.

```rust
pub async fn diagnose(
    &self,
    ticket: &Ticket,
    physics: &PhysicsReport,
    context: &[String],
) -> Result<StrategicReport> {
    // Build context string from vector DB results
    let context_str = if context.is_empty() {
        "No specific equipment context available.".to_string()
    } else {
        context
            .iter()
            .enumerate()
            .map(|(i, doc)| format!("{}. {}", i + 1, doc))
            .collect::<Vec<_>>()
            .join("\n")
    };

    // Build diagnosis prompt (see prompt in section 1)
    let prompt = format!(/* ... */);

    // Generate response
    let response = self
        .backend
        .generate_with_params(&prompt, 200, 0.3)
        .await
        .context("Strategic inference failed")?;

    // ... parse and return
}
```

### 2.2 Hourly Report Prompt (With Pre-calculated Score)

**File:** `src/strategic/actor.rs:344-361`

**Function:** `StrategicActor::build_hourly_prompt_with_score()`

```rust
fn build_hourly_prompt_with_score(
    &self,
    aggregate: &HourlyAggregate,
    health_score: f64,
    severity: &str,
) -> String {
    format!(
        r#"Hourly: {:.0}/100 ({}). BPFO {:+.4}g/h, Temp {:+.1}Â°C/h

Reply ONLY:
DIAGNOSIS: <10 words max>
ACTION: <10 words max>"#,
        health_score,
        severity,
        aggregate.bpfo_delta_per_hour,
        aggregate.motor_temp_delta_per_hour,
    )
}
```

### 2.3 Daily Report Prompt (With Pre-calculated Score)

**File:** `src/strategic/actor.rs:413-431`

**Function:** `StrategicActor::build_daily_prompt_with_score()`

```rust
fn build_daily_prompt_with_score(
    &self,
    aggregate: &DailyAggregate,
    health_score: f64,
    severity: &str,
) -> String {
    format!(
        r#"Daily: {:.0}/100 ({}). Trend {:+.2}/h, BPFO {:.4}g

Reply ONLY:
DIAGNOSIS: <10 words max>
ACTION: <10 words max>"#,
        health_score,
        severity,
        aggregate.health_score_trend,
        aggregate.mean_bpfo,
    )
}
```

### 2.4 Legacy Hourly/Daily Prompts (Deprecated)

**Files:** `src/strategic/actor.rs:365-409` and `src/strategic/actor.rs:434-481`

These longer prompts ask the LLM to generate HEALTHSCORE and SEVERITY (not recommended - use deterministic scoring).

---

## 3. STRATEGIC INPUT DATA STRUCTURES

### 3.1 For Anomaly Diagnosis

**File:** `src/types.rs:166-186`

**Struct:** `Ticket`

```rust
/// Anomaly ticket generated by tactical agent (Phase 3)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Ticket {
    /// Unix timestamp of the anomaly
    pub timestamp: u64,
    /// Sensor that triggered the ticket
    pub sensor_name: String,
    /// Type of anomaly detected (e.g., "BPFO spike", "Elevated Kurtosis")
    pub anomaly_type: String,
    /// Initial severity from tactical agent
    pub severity: TicketSeverity,
    /// Confidence level (0.0 to 1.0)
    pub confidence: f64,
    /// Kurtosis value at time of detection
    pub kurtosis: f64,
    /// BPFO amplitude at time of detection
    pub bpfo_amplitude: f64,
    /// Operational state at time of detection
    pub state: OperationalState,
    /// The tactical metrics that triggered this ticket
    pub metrics: TacticalMetrics,
}
```

**File:** `src/types.rs:211-232`

**Struct:** `PhysicsReport`

```rust
/// Physics engine damage and wear calculations (Phase 5)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PhysicsReport {
    /// Cumulative damage index (Miner's rule)
    pub cumulative_damage: f64,
    /// Bearing L10 life in hours (ISO 281)
    pub l10_life_hours: f64,
    /// Wear acceleration (2nd derivative of damage history)
    pub wear_acceleration: f64,
    /// Confidence level of the calculations
    pub confidence: f64,
}
```

### 3.2 For Hourly Reports

**File:** `src/strategic/aggregation.rs` (implied)

**Struct:** `HourlyAggregate`

```rust
pub struct HourlyAggregate {
    pub start_time: DateTime<Utc>,
    pub end_time: DateTime<Utc>,
    pub mean_health_score: f64,
    pub min_health_score: f64,
    pub max_health_score: f64,
    pub mean_rpm: f64,
    pub mean_motor_temp: f64,
    pub motor_temp_delta_per_hour: f64,
    pub mean_gearbox_temp: f64,
    pub gearbox_temp_delta_per_hour: f64,
    pub mean_rms: f64,
    pub mean_bpfo: f64,
    pub bpfo_delta_per_hour: f64,
    pub mean_bpfi: f64,
    pub bpfi_delta_per_hour: f64,
}
```

### 3.3 For Daily Reports

**Struct:** `DailyAggregate`

```rust
pub struct DailyAggregate {
    pub start_time: DateTime<Utc>,
    pub end_time: DateTime<Utc>,
    pub mean_health_score: f64,
    pub min_health_score: f64,
    pub max_health_score: f64,
    pub health_score_trend: f64,  // points per hour
    pub mean_motor_temp: f64,
    pub mean_gearbox_temp: f64,
    pub mean_bpfo: f64,
    pub mean_bpfi: f64,
}
```

---

## 4. STRATEGIC LLM CALL CODE

### 4.1 Direct Call (Anomaly Diagnosis)

**File:** `src/llm/strategic_llm.rs:178-183`

```rust
// Generate response with moderate temperature for coherent output
let response = self
    .backend
    .generate_with_params(&prompt, 200, 0.3)
    .await
    .context("Strategic inference failed")?;
```

**Parameters:**
- `prompt`: The formatted diagnosis prompt
- `max_tokens`: `200`
- `temperature`: `0.3`

### 4.2 Via Scheduler (Hourly/Daily Reports)

**File:** `src/strategic/actor.rs:194` and `src/strategic/actor.rs:264`

```rust
// Hourly report
match self.scheduler.infer_strategic(prompt, 50, 0.2).await {
    Ok(response) => { /* ... */ }
    Err(e) => { /* ... */ }
}

// Daily report
match self.scheduler.infer_strategic(prompt, 50, 0.2).await {
    Ok(response) => { /* ... */ }
    Err(e) => { /* ... */ }
}
```

**Scheduler call** (`src/llm/scheduler.rs:162-187`):

```rust
pub async fn infer_strategic(
    &self,
    prompt: String,
    max_tokens: usize,
    temperature: f64,
) -> Result<String> {
    let request = InferenceRequest {
        model_id: ModelId::Strategic,
        priority: Priority::Strategic,  // P1 (lower than Tactical P0)
        prompt,
        max_tokens,
        temperature,
        response_tx,
        enqueued_at: Instant::now(),
    };
    // ...
}
```

**Parameters Summary:**

| Use Case | max_tokens | temperature |
|----------|------------|-------------|
| Anomaly Diagnosis | 200 | 0.3 |
| Hourly Report | 50 | 0.2 |
| Daily Report | 50 | 0.2 |

---

## 5. STRATEGIC OUTPUT DATA STRUCTURES

### 5.1 StrategicReport (Main Output)

**File:** `src/types.rs:302-344`

```rust
/// Strategic agent's final health report (Phase 8-9)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StrategicReport {
    /// Unix timestamp
    pub timestamp: u64,
    /// Health score (0-100, higher is better)
    pub health_score: u8,
    /// Final severity from ensemble voting
    pub severity: FinalSeverity,
    /// Diagnosis from LLM (human-readable)
    pub diagnosis: String,
    /// Recommended action from LLM
    pub action: String,
    /// Individual votes from all specialists
    pub votes: Vec<SpecialistVote>,
    /// Reasoning explaining the final decision
    pub reasoning: String,
    /// L10 bearing life in hours
    pub l10_life_hours: f64,
    /// Cumulative damage index
    pub cumulative_damage: f64,
    /// Wear acceleration trend
    pub wear_acceleration: f64,
    /// Context snippets used (from vector DB)
    pub context_used: Vec<String>,
}
```

### 5.2 HourlyReport (Parsed Output)

**File:** `src/strategic/parsing.rs:13-20`

```rust
/// Hourly strategic report (strict 4-line format)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct HourlyReport {
    pub health_score: f64,
    pub severity: String,
    pub diagnosis: String,
    pub action: String,
    pub raw: String,
}
```

### 5.3 DailyReport (Parsed Output)

**File:** `src/strategic/parsing.rs:22-31`

```rust
/// Daily strategic report (4-line header + optional DETAILS)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DailyReport {
    pub health_score: f64,
    pub severity: String,
    pub diagnosis: String,
    pub action: String,
    pub details: Option<DetailsSection>,
    pub raw: String,
}

/// Optional DETAILS section for daily reports
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DetailsSection {
    pub trend: String,
    pub top_drivers: String,
    pub confidence: String,
    pub next_check: String,
}
```

### 5.4 StrategicLLMStats

**File:** `src/llm/strategic_llm.rs:462-471`

```rust
pub struct StrategicLLMStats {
    pub inference_count: u64,
    pub avg_latency_ms: f64,
    pub critical_diagnoses: u64,
    pub high_diagnoses: u64,
    pub medium_diagnoses: u64,
    pub low_diagnoses: u64,
}
```

---

## 6. EXAMPLE STRATEGIC LLM OUTPUTS

### 6.1 Expected Output Format (Anomaly Diagnosis)

```
DIAGNOSIS: Outer race bearing defect detected with progressive wear pattern. Cumulative damage indicates 65% of theoretical fatigue limit reached with accelerating degradation.
ACTION: Schedule bearing replacement within 48 hours during next planned maintenance window.
```

### 6.2 Expected Output Format (Hourly Report)

```
DIAGNOSIS: Stable bearing health with minor BPFO increase.
ACTION: Continue monitoring, no action required.
```

### 6.3 Expected Output Format (Daily Report with Details)

```
DIAGNOSIS: Overall equipment health stable with minor variations.
ACTION: Continue normal operations with standard monitoring.
DETAILS:
TREND: Health score improving by 2 points per day
TOP_DRIVERS: Reduced motor temperatures and stable bearing signatures
CONFIDENCE: High
NEXT_CHECK: Reassess in 24h
```

### 6.4 Mock Outputs (When LLM Disabled)

**File:** `src/llm/strategic_llm.rs:255-300`

```rust
// Critical severity mock
let diag = format!(
    "Critical bearing degradation detected with only {:.0} hours remaining L10 life. \
     Outer race spalling pattern detected at BPFO frequency with accelerating wear rate of {:.1}x normal.",
    physics.l10_life_hours, physics.wear_acceleration
);
let act = "URGENT: Initiate controlled shutdown and replace main bearing assembly within 24 hours.";

// High severity mock
let diag = format!(
    "Elevated vibration signature consistent with developing outer race defect. \
     Current L10 life estimate is {:.0} hours with wear acceleration at {:.1}x baseline.",
    physics.l10_life_hours, physics.wear_acceleration
);
let act = "Schedule bearing inspection within 48-72 hours and prepare replacement bearing.";

// Medium severity mock
let diag = format!(
    "Moderate vibration increase detected, likely indicating early-stage bearing wear or lubrication degradation. \
     Fatigue damage accumulation at {:.2}% of limit.",
    physics.cumulative_damage * 100.0
);
let act = "Monitor closely and schedule inspection within 1 week during planned maintenance window.";

// Low severity mock
let diag = format!(
    "Minor vibration anomaly within acceptable parameters. \
     Current bearing health metrics show {:.0} hours remaining L10 life.",
    physics.l10_life_hours
);
let act = "Continue normal operations with standard monitoring schedule.";
```

### 6.5 Test Case Examples

**File:** `src/strategic/parsing.rs:405-417`

```
HEALTHSCORE: 75
SEVERITY: Warning
DIAGNOSIS: Increasing vibration at BPFO frequency detected.
ACTION: Monitor closely and schedule inspection.
```

```
HEALTHSCORE: 82
SEVERITY: Healthy
DIAGNOSIS: Overall equipment health stable with minor variations.
ACTION: Continue normal operations with standard monitoring.
DETAILS:
TREND: Health score improving by 2 points per day
TOP_DRIVERS: Reduced motor temperatures and stable bearing signatures
CONFIDENCE: High
NEXT_CHECK: Reassess in 24h
```

---

## 7. STRATEGIC MODEL CONFIGURATION

**Model:** DeepSeek R1 Distill Qwen 7B (Q4 quantized GGUF)

**File:** `src/llm/strategic_llm.rs:22-24`

```rust
/// Default model path for strategic model (DeepSeek 7B)
const DEFAULT_STRATEGIC_MODEL: &str = "models/deepseek-r1-distill-qwen-7b-q4.gguf";
```

**Environment Variable Override:** `STRATEGIC_MODEL_PATH`

**Generation Parameters:**

| Use Case | max_tokens | temperature | top_k | top_p |
|----------|------------|-------------|-------|-------|
| Anomaly Diagnosis | 200 | 0.3 | 50 | 0.9 |
| Hourly Report | 50 | 0.2 | 50 | 0.9 |
| Daily Report | 50 | 0.2 | 50 | 0.9 |

**Target Latency:** 800ms (from `src/llm/strategic_llm.rs:3-4, 214-220`)

```rust
//! Target latency: 800ms (acceptable for hourly/strategic analysis)

// Log if latency exceeds target
if elapsed.as_millis() > 800 {
    tracing::info!(
        latency_ms = elapsed.as_millis(),
        target_ms = 800,
        "Strategic inference latency (within acceptable range for deep analysis)"
    );
}
```

**Scheduler Priority:** P1 (lower than Tactical P0)

**File:** `src/llm/scheduler.rs:42-48`

```rust
pub enum Priority {
    /// P0: Tactical analysis (60-second loop)
    Tactical = 0,
    /// P1: Strategic analysis (hourly/daily)
    Strategic = 1,
}
```

**Scheduler Deadline Guard:**
- Strategic requests are deferred if tactical deadline is within 10 seconds
- Strategic requests are deferred if tactical requests are queued

**Model Loading:** Uses mistral.rs with CUDA/GPU support
- Max sequence length: 4096
- Max batch size: 1 (to prevent VRAM accumulation)
- PagedAttention: May be disabled due to CPU/GPU split on 7B model
- DType: F16 or BF16

---

## Summary Table

| Item | Location | Status |
|------|----------|--------|
| System Prompt | `src/llm/strategic_llm.rs:140-176` | Found (inline in prompt) |
| Prompt Construction | Multiple functions (see section 2) | Found |
| Input Structure | `Ticket`, `PhysicsReport`, `HourlyAggregate`, `DailyAggregate` | Found |
| LLM Call | `src/llm/strategic_llm.rs:178-183`, `src/strategic/actor.rs:194,264` | Found |
| Output Structure | `StrategicReport`, `HourlyReport`, `DailyReport` | Found |
| Example Outputs | Mock outputs + test cases | Found |
| Model Config | `src/llm/strategic_llm.rs:22-24` | Found |

---

## Architecture Note

The Strategic LLM serves **three distinct purposes**:

1. **Anomaly Diagnosis** (`StrategicLLM::diagnose()`)
   - Called when verified anomaly needs human-readable explanation
   - Receives: `Ticket` + `PhysicsReport` + vector DB context
   - Returns: `StrategicReport` with diagnosis and action

2. **Hourly Reports** (`StrategicActor::generate_hourly()`)
   - Generated every 60 tactical analyses
   - Uses deterministic health score + LLM for diagnosis text
   - Returns: `HourlyReport`

3. **Daily Reports** (`StrategicActor::generate_daily()`)
   - Generated every 24 hourly reports
   - Uses deterministic health score + LLM for diagnosis text
   - Returns: `DailyReport` with optional DETAILS section

The health score is calculated **deterministically** from physics data, while the LLM only generates the diagnosis and action text. This prevents LLM hallucination on numerical values.

---

## Comparison: Tactical vs Strategic LLM

| Property | Tactical LLM | Strategic LLM |
|----------|--------------|---------------|
| Model | Qwen 2.5 1.5B | DeepSeek R1 7B |
| Model Size | ~1GB | ~4GB |
| Purpose | Binary classification (fault/noise) | Generate diagnosis text |
| Output | "YES" or "NO" | Multi-sentence diagnosis + action |
| Target Latency | 60ms | 800ms |
| Actual Latency | ~330-520ms | ~400-800ms |
| Priority | P0 (highest) | P1 (deferred if P0 pending) |
| max_tokens | 10-40 | 50-200 |
| temperature | 0.1-0.2 | 0.2-0.3 |
| Frequency | Every anomaly detection | Hourly/Daily + per verified anomaly |
